{% extends "base_admin.html" %}
{% block content %}
{% load global_tag %}
{% load gestion_tag %}
{% include "controls/listado.html" %}
{% include "controls/dg_edicion.html" %}

<div id="app">
  <valle-listado v-bind:titulo='titulo'
                 v-bind:cabeceras='cabeceras'
                 v-bind:mensaje='mensaje'
                 v-bind:items='items'
                 v-on:action-click='action_click'
                 v-on:onsubmit="onsubmit"></valle-listado>

  <valle-dg-edicion v-bind:fields='fields'
                    v-bind:model='model'
                    v-bind:titulo_dg='titulo_dg'
                    ref="dg_edicion"
                    v-on:onsubmit="onsubmit_dg"
                    name='edit_camarero'
                    ></valle-dg-edicion>

</div>

<script type="text/javascript">
  Vue.use(Toasted);
  new Vue({
    delimiters: ['[[', ']]'],
    el:'#app',

    data:{
      titulo: 'Camareros',
      cabeceras: ['Nombre', 'Apellidos'],
      mensaje: 'Agregar nuevo camarero',
      items: [
        {% for l in listado %}
            { cols: ['{{l.nombre}}', '{{l.apellidos}}'],
              botones: [ {tipo:'activar', icon:'{{l|icon_activo}}' },
                         {tipo:'edit', icon:'fa-edit'},
                         {tipo:'borrar', icon:'fa-trash'},
                         {tipo:'pass', icon:'{{l|icon_pass}}' }],
              obj: {"id":{{l.id}}, "nombre": '{{l.nombre}}', "apellidos": '{{l.apellidos}}' }
            },
        {% endfor %}
      ],
      fields: [
           {% for field in form %}
              {
               name: '{{field.name}}',
               label: '{{ field.label }}',
               html: '{{ field|get_control_vue }}'
              },
           {% endfor %}
         ]
      ,
      titulo_dg: "Camarero nuevo",
      model: [ "nombre", "apellidos"],
      isNuevo: false,
    },
    methods:{
        action_click: function(obj, tipo){
          var cx = this;
          if (tipo=="borrar"){
            $.get('{% url "gestion:rm_camarero" id=1 %}'.replace('1', obj.obj.id), function(res){
                if (res == "success"){
                  cx.items.splice(cx.items.indexOf(obj), 1)
                }
            });
          }else if (tipo=="edit"){
             this.nuevo = false;
             obj.obj.item = obj;
             this.$refs.dg_edicion.show(obj.obj, "Editar camarero");
          }else if (tipo=="nuevo"){
             this.nuevo = true;
             this.$refs.dg_edicion.show(null, "Camarero nuevo");
          }else if (tipo=='pass') {
            $.get('{% url "gestion:rm_pass_camarero" id=1 %}'.replace('1', obj.obj.id), function(res){
                var index = cx.items.indexOf(obj);
                cx.items.splice(index, 1, res);
                Vue.toasted.show('Contrasea borrada con exito',  {
                  'position': 'top-center',
                  'fullWidth': true,
                  'duration': 2000,
                });
              });
          }else if (tipo=='activar') {
               $.get('{% url "gestion:autorizar_cam" id=1 %}'.replace('1', obj.obj.id), function(res){
                     var index = cx.items.indexOf(obj);
                     cx.items.splice(index, 1, res);
                     Vue.toasted.show('Ha sido modificada la autorizaci√≥n',  {
                       'position': 'top-center',
                       'fullWidth': true,
                       'duration': 2000,
                     });
                 });
          }
        },
        onsubmit: function(data){
          var cx = this;
          $.post('{% url "gestion:lista_camareros" %}', data, function(res){
              cx.items = res;
          });
        },
        onsubmit_dg: function(data, obj){
          var url = '';
          var cx = this;
          if (this.nuevo){
             url = '{% url "gestion:add_camarero"  %}'
          }else{
             url = '{% url "gestion:edit_camarero" id=1 %}'.replace('1', obj.id)
          }
          $.post(url, data, function(res){
             if(obj != null){
              var index = cx.items.indexOf(obj.item);
              cx.items.splice(index, 1, res);
            }else{
              cx.items.push(res);
            }
          });
          this.$refs.dg_edicion.hide();
        }
    }
  })
</script>

{% endblock content %}
