WITH borrado AS (SELECT *, lineaspedido.UID FROM historialnulos INNER JOIN lineaspedido ON historialnulos.IDLPedido=lineaspedido.ID ORDER BY ID DESC LIMIT 1) SELECT COUNT(lineaspedido.IDArt) AS Cantidad, lineaspedido.Precio, COUNT(lineaspedido.IDArt) * lineaspedido.Precio AS Total, lineaspedido.Descripcion, lineaspedido.Estado, lineaspedido.UID, mesas.Nombre FROM lineaspedido INNER JOIN infmesa ON infmesa.UID = lineaspedido.UID INNER JOIN mesas ON CAST(SUBSTR(infmesa.UID, 1, INSTR(infmesa.UID, '-') - 1) AS INT) = mesas.ID WHERE infmesa.UID IN (SELECT UID FROM borrado) GROUP BY lineaspedido.IDPedido, lineaspedido.IDArt, lineaspedido.Descripcion;